---
title: "Import income insufficiency data"
output:
  html_document:
    df_print: paged
---

# Importing income insufficiency data

```{r}
library(tidyverse)
library(readxl)

source('income_ins_functions.R')
```

## Consumer expenditure survey data

All consumer expenditure survey (CES) data was gathered from the BLS's CES website. The following expenses were collected from CES data: health insurance (by household size annd age), transportation, appareal and services, housekeeping supplies personal care products and services, reading, and misc.

The one screen data source application was used (https://data.bls.gov/PDQWeb/cx) for all CES expenses except for health insurance by age. From the one screen data source page, we selected the following items from boxes:

* For all items, 'Expenditures' was selected from 'Select One Category'.
* The selections in the 'Select one or more items' box depend on the item selected in the 'Subcategory' box. For each of the following subcategories, the corresponding 'Select one or more items' lines were selected:
    + Healthcare: health insurance;
    + Transportation: Vehicle purchases: Cars and trucks (used); Other vehicle expenses; Gasoline, other fuels, and motor oil; Vehicle insurance; Vehicle maintenance and repairs; Public and other transportation; and Vehicle finance charges;
    + Apparel and services: all;
    + Housing: Housekeeping supplies;
    + Personal care products and services: Personal care products and services;
    + Reading: Reading; and
    + Miscellaneous expenditures: Miscellaneous expenditures.
* In the 'Select one or mre demographics' box, size of consumer unit and region of residence were selected.
* Finally, the following items were selected from 'Select one or more characteristics: one person in consumer unit, two people in consumer unit, three people in consumer unit, four people in consumer unit, five or more people in consumer unit, all consumer units (LB1101), and region of residence: south.
* We then clicked 'Add to selection' after selections were made, followed by 'Get data'.
* From the next page we clicked 'More formatting options'.
* To create the raw data, we selected the following options:
    + Specify year range: 2006 to most recent year;
    + Selet view of the data > Multiseries table;
    + Output type > Text > tab delimited; and
    + click 'Retrieve data'.
* This takes us to a page with the raw data for all years and a given expense. We copied the text of the data into a .txt file.
* To extract column headers, we used the following option:
    + Specify year range: 2006 to most recent year;
    + Select view of the data > column format;
    + Output type > Text > tab delimited; and
    + click 'Retrieve data'.
* Like with the raw data, we then copy and pasted all output into a .txt file.

We used cross-tabulated tables for healthin insurance expenses by age and consumer unit size (https://www.bls.gov/cex/csxcross.htm). From this page we selected the excel file for each year under size of consumer unit by age of reference person > One person.

### Import and clean CES data (minus health insurance by age and consumer unit size)

All data except for health insurance by size of consumer unit and age contain a common format. Therefore, we can import and clean these dataset with a single function and for loop, and combine these datasets into one dataset.

```{r}
# create vectors of file names for raw data and headers
# we will loop through the file names, importing and cleaning data

# path to folder containing ces data
ces_path <- 'data/ces/'

# all raw data files end in raw_data.txt; therefore, we can identiy all such files in folder
data_files <- list.files(ces_path, pattern = 'raw_data.txt') %>%
  # sort alphabetically so that raw data order matches header order
  sort()
# header files contain 'header'
header_files <- list.files(ces_path, pattern = 'header') %>%
  sort()

# initialize dataframe to contain all ces data
df_ces <- data.frame()

# loop through each data file, import and clean data, and add to dataframe containing ces data
for (i in seq_along(data_files)) {
  # import ces expense file
  df_ces_single <- ff_clean_ces(paste0(ces_path, data_files[i]), 
                                paste0(ces_path, header_files[i]))
  # add to data frame containing all ces expenses
  df_ces <- bind_rows(df_ces, df_ces_single)
}
```

### Import and clean CES data for health insurance by age and consumer unit size

For health insurance by age and consumer unit size, each year is in a different file and all files share a common format. The year is represented in the final two digits of the file name. The block below loop through each file, importing and cleaning along the way.

```{r}
# get list of all files
health_age_files <- list.files(paste0(ces_path, 'health_ins_age'))

# initialize dataframe to store all health insurance by age data
ces_health <- data.frame()

# loop through each file
for (file_name in health_age_files) {
  
  # extract year from filename
  single_year <- str_match(file_name, '_([0-9][0-9]).')[2] %>%
    # convert to integer
    as.integer() %>%
    # year is only two integers (example: 06); so add 2000 to convert to 2006
    sum(2000)

  # import data
  health_age <- read_excel(paste0(ces_path, 'health_ins_age/', file_name), skip = 2) %>%
    # only select items column and two age columns
    select(Item, starts_with('65-74'), starts_with('75 years')) %>%
    # trim whitespace in all columns
    mutate_all(funs(str_trim(., side = 'both'))) %>%
    # only keep row showing health insurance expenses
    filter(Item == 'Health insurance') %>%
    # add year
    mutate(year = single_year)
  
  # change column names to ensure they are the same for every dataset
  colnames(health_age) <- c('Item', '65_74', '75_plus', 'Year')
  
  # add sinlge year to dataframe containing all years
  ces_health <- bind_rows(ces_health, health_age)

}

# convert fron wide (each age group is in its own row)
# to long (each age group is in a different row)
ces_health <- gather(ces_health, 'age_group', 'expense', `65_74`:`75_plus`) %>%
  # change age group names
  mutate(age_group = str_replace_all(age_group, '65_74', '65 to 74')) %>%
  mutate(age_group = str_replace_all(age_group, '75_plus', '75 plus')) %>%
  # convert expense to numeric
  mutate(expense = as.numeric(expense))

```

The cross tab of health insurance by consumer unit and age does not contain regional information. So, we will apply the regional ratio from the health insurance by one consumer unit data.

```{r}
# get ratio for health insurance by one consumer unit
ratio_one <- df_ces %>%
  filter(Characteristics == 'One person consumer unit',
         Item == 'Health insurance') %>%
  # we only need year and ratio, which will be merged with the healthin ins by consumer unit and age df
  select(Year, region_ratio)

# add ratio to health insurance by age and consumer unit dataframe
ces_health <- left_join(ces_health, ratio_one, by = 'Year') %>%
  mutate(age_group = round( expense * region_ratio, 0 )) %>%
  select(-region_ratio)
```

CES data is cleaned and can be exported.

```{r}

```