---
title: "Poverty Rates"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
---

```{r setup, include=FALSE}
# prevent printing or R code in the output
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE)
```

```{r import}
 # import functions and packages
library(tidyverse)
library(knitr)
library(kableExtra)
library(tidycensus)
# load custom ACS functions
source('../../functions/acs_load_funcs.R')
```
This markdown file produces individual datasets that filter the data in various ways. If you want to write out the datasets into an excel file where each sheet is a different dataset, change the line of code below to `write_to_excel <- TRUE`.

```{r}
# change to 'TRUE' to write out datasets to excel
write_to_excel <- TRUE
```

The poverty rate reflects the percentage of the population with incomeThe data for poverty rates comes American Fact Finder table S1701. 

### Data cleaning

This code block imports and cleans the data. It filters out unneeded NC counties and cleans up variable descriptions.

```{r}
geo_areas <- c('United States', 'North Carolina', 
                'Forsyth', 'Guilford', 'Durham')

df <- read_csv('data/poverty_all_years_counties.csv') %>%
  # only keep selected NC counties, the state of NC, and US data
  filter(geo_description %in% geo_areas,
         # only need rows showing the percent below poverty level, don't need count data
         str_detect(description, '^Percent'))
```

------

### US, NC, and county comparisions

#### Plot

The plot below shows the overall employment rate of the US, North Carolina, and Forsyth, Guilford, and Durham counties.

```{r}
df %>%
  # only keep total poverty rate
  filter(str_detect(description, '^Percent *below poverty level; Estimate; Population for whom poverty status is determined$')) %>%
  ggplot(aes(year, estimate, color = geo_description)) +
    geom_line(size = 1) +
    labs(title = 'Poverty rate by geographic area',
         color = 'Comparison Unit',
         y = 'Poverty rate (%)') +
    scale_x_continuous(breaks = seq(min(df$year), max(df$year), 1)) +
    theme_minimal()
```

#### Data

Below is the raw data for poverty rates by geographies.

```{r}
total_data <- df %>%
  # only keep total poverty rate
  filter(str_detect(description, '^Percent *below poverty level; Estimate; Population for whom poverty status is determined$')) %>%
  select(geo_description, year, estimate, moe, se, cv)

if (write_to_excel == TRUE) {
  excel_data <- total_data %>%
    # add type of column
    mutate(type = 'Poverty Rate',
           subtype = 'Total Population')
}

total_data %>% 
 # add color to CVs
  ff_cv_color() %>%
  kable(caption = 'Poverty rate by geographic area and year', escape = F,
        col.names = c('Geographic area', 'Year', 'Poverty Rate (%)', '95% MOE', 'St. Error', 'CV'))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
  
```

#### Z-scores

The table below shows z-scores of all comparison communities for the past two years. To change the comparison year, replace the `c(max(df$year), max(df$year)-1)` segment of `year_comparison <- max(df$year)` with the desired year or vector of years such as `c(2013, 2014, 2015)`.

```{r}
year_comparison <- c(max(df$year), max(df$year)-1)

df %>%
  # only keep total employment rate
  filter(str_detect(description, '^Percent *below poverty level; Estimate; Population for whom poverty status is determined$'),
         # only keep data for the most recent year
         year %in% year_comparison) %>%
  ff_acs_zscore('estimate', 'se', c('geo_description', 'year')) %>%
  ff_acs_zscore_kable(paste0("Comparison community z-scores", ' in ', paste0(year_comparison, collapse=' and ')))
```

------

### Forsyth County year-to-year trends

#### Z-scores

The plot above shows Forsyth County's yearly trend and the table below lists yearly z-scores.

```{r}
df %>%
  # only keep total employment rate
  filter(str_detect(description, '^Percent *below poverty level; Estimate; Population for whom poverty status is determined$'),
         # only keep Forsyth
         geo_description == 'Forsyth') %>%
  ff_acs_zscore('estimate', 'se', 'year') %>%
  ff_acs_zscore_kable('Forsyth County yearly trend z-scores')
```

------

### Forsyth County poverty rate by ethnicity

#### Plot

The plot below shows poverty rates by ethnicity and year.

```{r fig.width=8,fig.height=10}
ethnicity <- df %>%
  # filter for race
  ff_acs_ethnicity(description)

ethnicity %>%
  ggplot(aes(year, estimate, color = ethnicity)) +
    geom_line(size = 1) +
    # create a seperate plot for each geography
    facet_grid(rows = vars(geo_description)) +
    labs(title = 'Poverty rates by ethnicity',
         color = 'Ethnicity',
         y = 'Poverty rate (%)') +
    scale_x_continuous(breaks = seq(min(ethnicity$year), max(ethnicity$year), 1),
                       minor_breaks = NULL) +
    theme_minimal()
```

#### Data

The data for ethnicities is as follows.

```{r}
ethnicity_data <- ethnicity %>%
  select(geo_description, year, ethnicity, estimate, moe, se, cv) 

# write out data set to excel only needed
if (write_to_excel == TRUE) {
  
  excel_data <- ethnicity_data %>%
    # add type of column
    mutate(type = 'Race and Ethnicity',
           subtype = ethnicity) %>%
    # delete ethnicity column since this is now in the subtype column
    select(-ethnicity) %>%
    bind_rows(excel_data, .)
}
  
ethnicity_data %>%
  # add color to CVs
  ff_cv_color() %>%
  kable(caption = 'Povety rate by ethnicity', escape = F,
        col.names = c('Geographic area', 'Year', 'Ethnicity', 'Poverty rate (%)', '95% MOE', 'St. Error', 'CV'))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
```

#### Z-scores

Below is a table of z-scores for ethnicities in the past two years. To generate z-scores for other years, replace `c(max(ethnicity$year), max(ethnicity$year)+1)` in `ethnicity_years <- c(max(ethnicity$year), max(ethnicity$year)+1)` with the desired year.

```{r}
# enter comparison years here
ethnicity_years <- c(max(ethnicity$year), max(ethnicity$year)-1)

ethnicity %>%
  filter(year %in% ethnicity_years) %>%
  ff_acs_zscore('estimate', 'se', c('year','geo_description', 'ethnicity'))  %>%
  ff_acs_zscore_kable(paste0('Z-scores by year and ethnicity', ' in ', paste(ethnicity_years, collapse = ' and ')))
```

The next table has ethnicity z-scores for all years within Forsyth County.

```{r}
ethnicity %>%
  filter(geo_description == 'Forsyth') %>%
  ff_acs_zscore('estimate', 'se', c('year', 'ethnicity'))  %>%
  ff_acs_zscore_kable('Forsyth County z-scores by year and ethnicity')
```

------

### Forsyth County poverty by age

#### Plot

In 2015, the Census created additional age groups, such as under 5 and 5 to 17. Prior to 2015, however, the youngest age group was 18 and under. Therefore, yearly age comparisons only trace back to 2015.

```{r fig.width=6,fig.height=10}
# list of the end of age rows, to filter on
age_descriptions <- c('Under 5 years',
                      '5 to 17 years',
                      '18 to 34 years',
                      '35 to 64 years',
                      '65 years and over')

# create regular expression to filter data set and only keep rows that have one of the 
# age descriptions at the end of the row description
age_re <- paste0(age_descriptions, collapse = '$|')

age <- df %>%
  # only keep variables for 2015 and later
  filter(year >= 2015,
         str_detect(description, age_re)) %>%
  # create new column that extracts the age from the description column
  mutate(age = str_extract(description, age_re))
  
age %>%
    ggplot(aes(year, estimate, color = age)) +
    geom_line(size = 1) +
    # create a seperate plot for each geography
    facet_grid(rows = vars(geo_description)) +
    labs(title = 'Forsyth county poverty rate by age group',
         color = 'Age group',
         y = 'Poverty rate (%)') +
    scale_x_continuous(breaks = seq(min(age$year), max(age$year), 1),
                       minor_breaks = NULL) +
    # change the order of age groups in legend so they appear youngest to oldest
    scale_color_discrete(breaks=age_descriptions) +
    theme_minimal()
```

#### Data

Age data is below.

```{r}
age_data <- age %>%
  select(geo_description, year, age, estimate, moe, se, cv)

 # write out data set to excel only needed
if (write_to_excel == TRUE) {
  
  excel_data <- age_data %>%
    # add type of column
    mutate(type = 'Age Group',
           subtype = age) %>%
    # delete ethnicity column since this is now in the subtype column
    select(-age) %>%
    bind_rows(excel_data, .)
}  
  
age_data %>%
  # add color to CVs
  ff_cv_color() %>%
  kable(caption = 'Poverty rate by age', escape = FALSE,
        col.names = c('Geographic area', 'Year', 'Age group', 'Poverty rate (%)', '95% MOE', 'St. Error', 'CV'))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
```

#### Z-scores

The table below highlights z-scores for each age group in the past two years.

```{r}
# enter comparison years here
age_years <- c(max(age$year), max(age$year)-1)

age %>%
  filter(year %in% age_years) %>%
  ff_acs_zscore('estimate', 'moe', c('year', 'geo_description', 'age'))  %>%
  ff_acs_zscore_kable(paste0('Z-scores by age group', ' in ', paste(age_years, collapse = ' and ')))
```

Here are the age comparisons for all years within Forsyth County.

```{r}
age %>%
  filter(geo_description == 'Forsyth') %>%
  ff_acs_zscore('estimate', 'moe', c('year', 'age'))  %>%
  ff_acs_zscore_kable(paste0('Forsyth County z-scores by age group'))
```


Write out excel workbook if needed.

```{r}
# estimates are percentages displayed in tens (60.45)
# convert to numbers to decimal percentages (.6045)
excel_data %>%
  mutate_at(vars(estimate:se), funs(./100)) %>%
  # write to excel
  ff_write_to_excel(., write_to_excel, 'poverty_rate.xlsx')
```