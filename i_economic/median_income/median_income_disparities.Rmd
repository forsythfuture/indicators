---
title: "Median Income Disparities"
output:
  html_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
# prevent printing or R code in the output
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE)
```

```{r import}
 # import functions and packages
library(tidyverse)
library(knitr)
library(kableExtra)
library(tidycensus)
# load custom ACS functions
source('../../functions/acs_load_funcs.R')

```

This markdown file produces individual datasets that filter the data in various ways. If you want to write out the datasets into an excel file where each sheet is a different dataset, change the line of code below to `write_to_excel <- TRUE`.

```{r}
# change to 'TRUE' to write out datasets to excel
write_to_excel <- FALSE


if (write_to_excel == TRUE) {
  # install package to write to excel only if it is needed
  library(openxlsx)
  
  # name of the excel file to save to (can be changed)
  excel_file <- 'median_income_disparities.xlsx'
  
  # create workbook to save sheets to
  wb <- createWorkbook()
}
```

Median income data comes American Fact Finder table S1903.

### Data cleaning

This code block imports and cleans the data. It filters out unneeded NC counties and rows, and cleans up variable descriptions.

```{r}
# create list of geographic areas to keep
geo_areas <- c('United States', 'North Carolina', 
                'Forsyth', 'Guilford', 'Durham')

df <- read_csv('data/median_income_all_years_counties.csv') %>%
  # only keep rows for the US, NC, Forsyth, Guilford, and Durham
  filter(geo_description %in% geo_areas,
         # remove 'PERCENT IMPUTED' rows
         !str_detect(description, 'PERCENT IMPUTED'),
         # remove 'PERCENT ALLOCATED' rows
         !str_detect(description, 'PERCENT ALLOCATED'),
         # we are only looking at households, so remove families and non-family household
         !str_detect(description, 'FAMILIES -'),
         !str_detect(description, 'NONFAMILY HOUSEHOLDS -'),
         # filter out total columns because we only need median incomes, not counts
         !str_detect(description, 'Total'),
         # starting in 2017, total number of people and percent is in data; remove these so we only have median incomes
         !str_detect(description, '^Number;'),
         !str_detect(description, '^Percent'))

# years will be needed alter
years <- seq(2006, 2017, 1)
```

------

### Median income disparities by race and ethnicity

Disparities by ethnicity reflect ratios between white median income and african american or hispanic median income.
 
#### Create disparities by race and ethnicity dataset

The code block below calculates disparities by ethnicity, along with the se, moe, and cv.

```{r}
# filter for ethnicity data
ethnic_ratios <- df %>%
  # filter for race
  ff_acs_ethnicity(description) %>%
  # calculate ratios
  ff_ratios_race(years, geo_areas)
```

#### Plot

The plot below shows employment rate disparities by ethnicity and year. 

```{r}
ethnic_ratios %>%
  ggplot(aes(year, ratio, color = geo_description)) +
    geom_line(size = 1) +
    # create seperate plots for each ethnicity comparison
    facet_wrap(vars(description), nrow=2) +
    # create bold vertical line at 1
    geom_hline(yintercept = 1) +
    labs(title = 'Forsyth county median income ratios by ethnicity',
         color = 'Comparison communities',
         y = 'Ratio') +
    scale_x_continuous(breaks = seq(min(ethnic_ratios$year), max(ethnic_ratios$year), 1),
                       minor_breaks = NULL) +
    theme_minimal()
```

#### Data

The data for ethnicities is as follows.

```{r}
ethnic_ratios %>%
  select(geo_description, year, description, ratio, moe, se, cv) %T>%
  # write out data set to excel only needed
  {if (write_to_excel == TRUE) {
    addWorksheet(wb, "ethnicities") # create workbook
    writeData(wb, "ethnicities", ., rowNames = FALSE) # write data to workbook
  } else .} %>%
  # add color to CVs
  ff_cv_color() %>%
  kable(caption = 'Median income disparities by ethnicity', escape=FALSE,
        col.names = c('Geographic area', 'Year', 'Comparison ethnicities', 'Ratio', '95% MOE', 'St. Error', 'CV'))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
```

#### Z-scores

Below are tables of z-scores for median income disparities by ethnicity comparisons and geographic area in the past two years. To generate z-scores for other years, replace `c(max(ethnicity$year), max(ethnicity$year)+1)` in `ethnicity_years <- c(max(ethnicity$year), max(ethnicity$year)+1)` with the desired years. For all years, enter `ethnicity_years <- years`.

**White to african american median income disparities**
```{r}
# enter comparison years here
ethnicity_years <- c(max(ethnic_ratios$year), max(ethnic_ratios$year)-1)

ethnic_ratios %>%
  filter(year %in% ethnicity_years,
         description == 'White to african american ratio') %>%
  ff_acs_zscore('ratio', 'se', c('year', 'geo_description'))  %>%
  ff_acs_zscore_kable('White to african american median income disparity z-scores by year and geographic area')
```

**White to hispanic/latinx median income disparities**

```{r}
# enter comparison years here
ethnicity_years <- c(max(ethnic_ratios$year), max(ethnic_ratios$year)-1)

ethnic_ratios %>%
  filter(year %in% ethnicity_years,
         description == 'White to hispanic/latinx ratio') %>%
  ff_acs_zscore('ratio', 'se', c('year', 'geo_description'))  %>%
  ff_acs_zscore_kable('White to hispanic/latinx disparities median income disparity z-scores by year and geographic area')
```

And here are the z-scores for all years with Forsyth County.

**Forsyth County white to african american median income disparities**
```{r}
ethnic_ratios %>%
  filter(geo_description == 'Forsyth',
         description == 'White to african american ratio') %>% 
  ff_acs_zscore('ratio', 'se', c('year', 'geo_description'))  %>%
  ff_acs_zscore_kable('White to african american median income disparity z-scores for Forsyth County')
```

**Forsyth County white to hispanic/latinx median income disparities**

```{r}
ethnic_ratios %>%
  filter(geo_description == 'Forsyth',
         description == 'White to hispanic/latinx ratio') %>%
  ff_acs_zscore('ratio', 'se', c('year', 'geo_description'))  %>%
  ff_acs_zscore_kable('White to hispanic/latinx median income disparity z-scores for Forsyth County')
```





Write out excel workbook if needed.

```{r}
if (write_to_excel == TRUE) {
  saveWorkbook(wb, excel_file, overwrite=T)
} 